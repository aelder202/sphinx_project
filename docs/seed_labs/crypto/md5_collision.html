

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>MD5 Collision Attack Lab &mdash; Network Security Lab  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Padding Oracle Attack Lab" href="padding_oracle.html" />
    <link rel="prev" title="Hash Length Extension Attack Lab" href="hash_length_ext.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Network Security Lab
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../xie/xie_labs.html">Xie Labs</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../seed_index.html">SEED Labs</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="crypto_index.html">Cryptography Labs</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="encryption.html">Secret-Key Encryption Lab</a></li>
<li class="toctree-l3"><a class="reference internal" href="hash_length_ext.html">Hash Length Extension Attack Lab</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">MD5 Collision Attack Lab</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lab-environment">Lab Environment.</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-1-generating-two-different-files-with-the-same-md5-hash">Task 1: Generating Two Different Files with the Same MD5 Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-2-understanding-md5s-property">Task 2: Understanding MD5’s Property</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-3-generating-two-executable-files-with-the-same-md5-hash">Task 3: Generating Two Executable Files with the Same MD5 Hash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#task-4-making-the-two-programs-behave-differently">Task 4: Making the Two Programs Behave Differently</a></li>
<li class="toctree-l4"><a class="reference internal" href="#submission">Submission</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="padding_oracle.html">Padding Oracle Attack Lab</a></li>
<li class="toctree-l3"><a class="reference internal" href="pki.html">Public-Key Infrastructure (PKI) Lab</a></li>
<li class="toctree-l3"><a class="reference internal" href="random_number.html">Pseudo Random Number Generation Lab</a></li>
<li class="toctree-l3"><a class="reference internal" href="rsa.html">RSA Public-Key Encryption and Signature Lab</a></li>
<li class="toctree-l3"><a class="reference internal" href="tls.html">Transport Layer Security (TLS) Lab</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../hardware/hardware_index.html">Hardware Labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mobile/mobile_index.html">Mobile Security Labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../network/network_index.html">Network Security Labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../web/web_index.html">Web Security Labs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../software/software_index.html">Software Security Labs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../website_link/web_index.html"><strong>Return To Website</strong></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Network Security Lab</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../seed_index.html">SEED Labs</a> &raquo;</li>
        
          <li><a href="crypto_index.html">Cryptography Labs</a> &raquo;</li>
        
      <li>MD5 Collision Attack Lab</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="center docutils container">
MD5 Collision Attack Lab</div>
<div class="section" id="md5-collision-attack-lab">
<h1>MD5 Collision Attack Lab<a class="headerlink" href="#md5-collision-attack-lab" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>A secure one-way hash function needs to satisfy two properties: the
one-way property and the collision-resistance property. The one-way
property ensures that given a hash value <code class="docutils literal notranslate"><span class="pre">h</span></code>, it is computationally
infeasible to find an input <span class="math notranslate nohighlight">\(M\)</span>, such that <code class="docutils literal notranslate"><span class="pre">hash(M)</span> <span class="pre">=</span> <span class="pre">h</span></code>. The
collision-resistance property ensures that it is computationally
infeasible to find two different inputs <code class="docutils literal notranslate"><span class="pre">M_1</span></code> and <code class="docutils literal notranslate"><span class="pre">M_2</span></code>, such that
<code class="docutils literal notranslate"><span class="pre">hash(M_1)</span> <span class="pre">=</span> <span class="pre">hash(M_2)</span></code>.</p>
<p>Several widely-used one-way hash functions have trouble maintaining the
collision-resistance property. At the rump session of CRYPTO 2004,
Xiaoyun Wang and co-authors demonstrated a collision attack against
MD5. In February 2017, CWI Amsterdam
and Google Research announced the <em>SHAttered</em> attack, which breaks the
collision-resistance property of SHA-1.
While many students do not have trouble understanding the importance of
the one-way property, they cannot easily grasp why the
collision-resistance property is necessary, and what impact these
attacks can cause.</p>
<p>The learning objective of this lab is for students to really understand
the impact of collision attacks, and see in first hand what damages can
be caused if a widely-used one-way hash function’s collision-resistance
property is broken. To achieve this goal, students need to launch actual
collision attacks against the MD5 hash function. Using the attacks,
students should be able to create two different programs that share the
same MD5 hash but have completely different behaviors. This lab covers a
number of topics described in the following:</p>
<ul class="simple">
<li>One-way hash function, MD5</li>
<li>The collision-resistance property</li>
<li>Collision attacks</li>
</ul>
<div class="section" id="readings">
<h3>Readings.<a class="headerlink" href="#readings" title="Permalink to this headline">¶</a></h3>
<p>Detailed coverage of the one-way hash function can be found in the
following:</p>
<ul class="simple">
<li>Chapter 22 of the SEED Book, <em>Computer &amp; Internet Security: A
Hands-on Approach</em>, 2nd Edition, by Wenliang Du. See details at
<a class="reference external" href="https://www.handsonsecurity.net">https://www.handsonsecurity.net</a>.</li>
</ul>
</div>
</div>
<div class="section" id="lab-environment">
<h2>Lab Environment.<a class="headerlink" href="#lab-environment" title="Permalink to this headline">¶</a></h2>
<p>This lab has been tested on our pre-built Ubuntu 20.04 VM, which can be
downloaded from the SEED website.&nbsp;&nbsp;The lab uses a tool called “Fast MD5
Collision Generation”, which was written by Marc Stevens. The name of
the binary is called <code class="docutils literal notranslate"><span class="pre">md5collgen</span></code> in our VM, and it is installed
inside the <code class="docutils literal notranslate"><span class="pre">/usr/bin</span></code> folder. If it is not there, you can download it
from the lab’s website (inside <code class="docutils literal notranslate"><span class="pre">Labsetup.zip</span></code>). If you are interested
in installing the tool to your own machine, you can download the source
code directly from <a class="reference external" href="https://www.win.tue.nl/hashclash/">https://www.win.tue.nl/hashclash/</a>.</p>
<div class="section" id="acknowledgment">
<h3>Acknowledgment<a class="headerlink" href="#acknowledgment" title="Permalink to this headline">¶</a></h3>
<p>This lab was developed with the help of Vishtasp Jokhi, a graduate
student in the Department of Electrical Engineering and Computer Science
at Syracuse University.</p>
</div>
</div>
<div class="section" id="task-1-generating-two-different-files-with-the-same-md5-hash">
<h2>Task 1: Generating Two Different Files with the Same MD5 Hash<a class="headerlink" href="#task-1-generating-two-different-files-with-the-same-md5-hash" title="Permalink to this headline">¶</a></h2>
<p>In this task, we will generate two different files with the same MD5
hash values. The beginning parts of these two files need to be the same,
i.e., they share the same prefix. We can achieve this using the
<code class="docutils literal notranslate"><span class="pre">md5collgen</span></code> program, which allows us to provide a prefix file with
any arbitrary content. The way how the program works is illustrated in
<strong>Figure&nbsp;1</strong>. The following command generates two
output files, <code class="docutils literal notranslate"><span class="pre">out1.bin</span></code> and <code class="docutils literal notranslate"><span class="pre">out2.bin</span></code>, for a given a prefix file
<code class="docutils literal notranslate"><span class="pre">prefix.txt</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ md5collgen -p prefix.txt -o out1.bin out2.bin
</pre></div>
</div>
<div class="align-center figure" id="id2">
<img alt="alternate text" src="../../_images/generate_collision.jpg" />
<p class="caption"><span class="caption-text">Figure 1: MD5 collision generation from a prefix</span></p>
</div>
<p>We can check whether the output files are distinct or not using the
<code class="docutils literal notranslate"><span class="pre">diff</span></code> command. We can also use the <code class="docutils literal notranslate"><span class="pre">md5sum</span></code> command to check the
MD5 hash of each output file. See the following commands.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ diff out1.bin out2.bin
$ md5sum out1.bin
$ md5sum out2.bin
</pre></div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">out1.bin</span></code> and <code class="docutils literal notranslate"><span class="pre">out2.bin</span></code> are binary, we cannot view them
using a text-viewer program, such as <code class="docutils literal notranslate"><span class="pre">cat</span></code> or <code class="docutils literal notranslate"><span class="pre">more</span></code>; we need to use
a binary editor to view (and edit) them. We have already installed a hex
editor software called <code class="docutils literal notranslate"><span class="pre">bless</span></code> in our VM. Please use such an editor to
view these two output files, and describe your observations. In
addition, you should answer the following questions:</p>
<ul class="simple">
<li><strong>Question 1.</strong> If the length of your prefix file is not multiple of
64, what is going to happen?</li>
<li><strong>Question 2.</strong> Create a prefix file with exactly 64 bytes, and run
the collision tool again, and see what happens.</li>
<li><strong>Question 3.</strong> Are the data (128 bytes) generated by <code class="docutils literal notranslate"><span class="pre">md5collgen</span></code>
completely different for the two output files? Please identify all
the bytes that are different.</li>
</ul>
</div>
<div class="section" id="task-2-understanding-md5s-property">
<h2>Task 2: Understanding MD5’s Property<a class="headerlink" href="#task-2-understanding-md5s-property" title="Permalink to this headline">¶</a></h2>
<p>In this task, we will try to understand some of the properties of the
MD5 algorithm. These properties are important for us to conduct further
tasks in this lab. MD5 is a quite complicated algorithm, but from very
high level, it is not so complicated. As
<strong>Figure&nbsp;2</strong> shows, MD5 divides the input data
into blocks of 64 bytes, and then computes the hash iteratively on these
blocks. The core of the MD5 algorithm is a compression function, which
takes two inputs, a 64-byte data block and the outcome of the previous
iteration. The compression function produces a 128-bit IHV, which stands
for “Intermediate Hash Value”; this output is then fed into the next
iteration. If the current iteration is the last one, the IHV will be the
final hash value. The IHV input for the first iteration
(IHV<span class="math notranslate nohighlight">\(_0\)</span>) is a fixed value.</p>
<div class="align-center figure" id="id3">
<img alt="How the MD5 algorithm works" src="../../_images/How_MD5_works.jpg" />
<p class="caption"><span class="caption-text">Figure 2: How the MD5 algorithm works</span></p>
</div>
<p>Based on how MD5 works, we can derive the following property of the MD5
algorithm: Given two inputs <code class="docutils literal notranslate"><span class="pre">M</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code>, if <code class="docutils literal notranslate"><span class="pre">MD5(M)</span> <span class="pre">=</span> <span class="pre">MD5(N)</span></code>,
i.e., the MD5 hashes of <code class="docutils literal notranslate"><span class="pre">M</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code> are the same, then for any input
<code class="docutils literal notranslate"><span class="pre">T</span></code>, <code class="docutils literal notranslate"><span class="pre">MD5(M</span> <span class="pre">\|</span> <span class="pre">T)</span> <span class="pre">=</span> <span class="pre">MD5(N</span> <span class="pre">\|</span> <span class="pre">T)</span></code>, where <code class="docutils literal notranslate"><span class="pre">\|</span></code> represents
concatenation.</p>
<p>That is, if inputs <code class="docutils literal notranslate"><span class="pre">M</span></code> and <code class="docutils literal notranslate"><span class="pre">N</span></code> have the same hash, adding the same
suffix <code class="docutils literal notranslate"><span class="pre">T</span></code> to them will result in two outputs that have the same hash
value. This property holds not only for the MD5 hash algorithm, but also
for many other hash algorithms. <em>Your job in this task</em> is to design an
experiment to demonstrates that this property holds for MD5.</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">cat</span></code> command to concatenate two files (binary or text
files) into one. The following command concatenates the contents of
<code class="docutils literal notranslate"><span class="pre">file2</span></code> to the contents of <code class="docutils literal notranslate"><span class="pre">file1</span></code>, and places the result in
<code class="docutils literal notranslate"><span class="pre">file3</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cat file1 file2 &gt; file3
</pre></div>
</div>
</div>
<div class="section" id="task-3-generating-two-executable-files-with-the-same-md5-hash">
<h2>Task 3: Generating Two Executable Files with the Same MD5 Hash<a class="headerlink" href="#task-3-generating-two-executable-files-with-the-same-md5-hash" title="Permalink to this headline">¶</a></h2>
<p>In this task, you are given the following C program. Your job is to
create two different versions of this program, such that the contents of
their <code class="docutils literal notranslate"><span class="pre">xyz</span></code> arrays are different, but the hash values of the
executables are the same.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xyz</span><span class="p">[</span><span class="mi">200</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
 <span class="cm">/* The actual contents of this array are up to you */</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="n">xyz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You may choose to work at the source code level, i.e., generating two
versions of the above C program, such that after compilation, their
corresponding executable files have the same MD5 hash value. However, it
may be easier to directly work on the binary level. You can put some
arbitrary values in the <code class="docutils literal notranslate"><span class="pre">xyz</span></code> array, compile the above code to binary.
Then you can use a hex editor tool to modify the content of the <code class="docutils literal notranslate"><span class="pre">xyz</span></code>
array directly in the binary file.</p>
<p>Finding where the contents of the array are stored in the binary is not
easy. However, if we fill the array with some fixed values, we can
easily find them in the binary. For example, the following code fills
the array with <code class="docutils literal notranslate"><span class="pre">0x41</span></code>, which is the ASCII value for letter <code class="docutils literal notranslate"><span class="pre">A</span></code>. It
will not be difficult to locate 200 <code class="docutils literal notranslate"><span class="pre">A</span></code>’s in the binary.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>unsigned char xyz[200] = {
  0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
  0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
  0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
  ... (omitted) ...
  0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41, 0x41,
}
</pre></div>
</div>
<div class="section" id="guidelines">
<h3>Guidelines.<a class="headerlink" href="#guidelines" title="Permalink to this headline">¶</a></h3>
<p>From inside the array, we can find two locations, from where we can divide the executable file into three parts: a prefix, a 128-byte region, and a suffix. The length of the prefix needs to be multiple of 64 bytes. Se  <strong>Figure&nbsp;3</strong> for an illustration of how the file is divided.</p>
<div class="align-center figure" id="id4">
<img alt="Break the executable file into three pieces." src="../../_images/fill_array.jpg" />
<p class="caption"><span class="caption-text">Figure 3: Break the executable file into three pieces.</span></p>
</div>
<p>We can run <code class="docutils literal notranslate"><span class="pre">md5collgen</span></code> on the prefix to generate two outputs that
have the same MD5 hash value. Let us use <code class="docutils literal notranslate"><span class="pre">P</span></code> and <code class="docutils literal notranslate"><span class="pre">Q</span></code> to represent
the second part (each having 128 bytes) of these outputs (i.e., the part
after the prefix). Therefore, we have the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>MD5 (prefix (*@$\|$@*) P) = MD5 (prefix (*@$\|$@*) Q)
</pre></div>
</div>
<p>Based on the property of MD5, we know that if we append the same suffix
to the above two outputs, the resultant data will also have the same
hash value. Basically, the following is true for any suffix:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>MD5 (prefix (*@$\|$@*) P (*@$\|$@*) suffix) = MD5 (prefix (*@$\|$@*) Q (*@$\|$@*) suffix)
</pre></div>
</div>
<p>Therefore, we just need to use <code class="docutils literal notranslate"><span class="pre">P</span></code> and <code class="docutils literal notranslate"><span class="pre">Q</span></code> to replace 128 bytes of
the array (between the two dividing points), and we will be able to
create two binary programs that have the same hash value. Their outcomes
are different, because they each print out their own arrays, which have
different contents.</p>
</div>
<div class="section" id="tools">
<h3>Tools.<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<p>You can use <code class="docutils literal notranslate"><span class="pre">bless</span></code> to view the binary executable file and find the
location for the array. For dividing a binary file, there are some tools
that we can use to divide a file from a particular location. The
<code class="docutils literal notranslate"><span class="pre">head</span></code> and <code class="docutils literal notranslate"><span class="pre">tail</span></code> commands are such useful tools. You can look at
their manuals to learn how to use them. We give three examples in the
following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ head -c 3200 a.out &gt; prefix
$ tail -c 100 a.out &gt; suffix
$ tail -c +3300 a.out &gt; suffix
</pre></div>
</div>
<p>The first command above saves the first <code class="docutils literal notranslate"><span class="pre">3200</span></code> bytes of <code class="docutils literal notranslate"><span class="pre">a.out</span></code> to
<code class="docutils literal notranslate"><span class="pre">prefix</span></code>. The second command saves the last <code class="docutils literal notranslate"><span class="pre">100</span></code> bytes of <code class="docutils literal notranslate"><span class="pre">a.out</span></code>
to <code class="docutils literal notranslate"><span class="pre">suffix</span></code>. The third command saves the data from the <code class="docutils literal notranslate"><span class="pre">3300</span></code>th
byte to the end of the file <code class="docutils literal notranslate"><span class="pre">a.out</span></code> to <code class="docutils literal notranslate"><span class="pre">suffix</span></code>. With these two
commands, we can divide a binary file into pieces from any location. If
we need to glue some pieces together, we can use the <code class="docutils literal notranslate"><span class="pre">cat</span></code> command.</p>
<p>If you use <code class="docutils literal notranslate"><span class="pre">bless</span></code> to copy-and-paste a block of data from one binary
file to another file, the menu item <code class="docutils literal notranslate"><span class="pre">&quot;Edit</span> <span class="pre">-&gt;</span> <span class="pre">Select</span> <span class="pre">Range&quot;</span></code> is quite
handy, because you can select a block of data using a starting point and
a range, instead of manually counting how many bytes are selected.</p>
</div>
</div>
<div class="section" id="task-4-making-the-two-programs-behave-differently">
<h2>Task 4: Making the Two Programs Behave Differently<a class="headerlink" href="#task-4-making-the-two-programs-behave-differently" title="Permalink to this headline">¶</a></h2>
<p>In the previous task, we have successfully created two programs that
have the same MD5 hash, but their behaviors are different. However,
their differences are only in the data they print out; they still
execute the same sequence of instructions. In this task, we would like
to achieve something more significant and more meaningful.</p>
<p>Assume that you have created a software which does good things. You send
the software to a trusted authority to get certified. The authority
conducts a comprehensive testing of your software, and concludes that
your software is indeed doing good things. The authority will present
you with a certificate, stating that your program is good. To prevent
you from changing your program after getting the certificate, the MD5
hash value of your program is also included in the certificate; the
certificate is signed by the authority, so you cannot change anything on
the certificate or your program without rendering the signature invalid.</p>
<p>You would like to get your malicious software certified by the
authority, but you have zero chance to achieve that goal if you simply
send your malicious software to the authority. However, you have noticed
that the authority uses MD5 to generate the hash value. You got an idea.
You plan to prepare two different programs. One program will always
execute benign instructions and do good things, while the other program
will execute malicious instructions and cause damages. You find a way to
get these two programs to share the same MD5 hash value.</p>
<p>You then send the benign version to the authority for certification.
Since this version does good things, it will pass the certification, and
you will get a certificate that contains the hash value of your benign
program. Because your malicious program has the same hash value, this
certificate is also valid for your malicious program. Therefore, you
have successfully obtained a valid certificate for your malicious
program. If other people trusted the certificate issued by the
authority, they will download your malicious program.</p>
<p><em>The objective of this task</em> is to launch the attack described above.
Namely, you need to create two programs that share the same MD5 hash.
However, one program will always execute benign instructions, while the
other program will execute malicious instructions. In your work, what
benign/malicious instructions are executed is not important; it is
sufficient to demonstrate that the instructions executed by these two
programs are different.</p>
<div class="section" id="guidelines-1">
<span id="id1"></span><h3>Guidelines.<a class="headerlink" href="#guidelines-1" title="Permalink to this headline">¶</a></h3>
<p>Creating two completely different programs that produce the same MD5
hash value is quite hard. The two hash-colliding programs produced by
<code class="docutils literal notranslate"><span class="pre">md5collgen</span></code> need to share the same prefix; moreover, as we can see
from the previous task, if we need to add some meaningful suffix to the
outputs produced by <code class="docutils literal notranslate"><span class="pre">md5collgen</span></code>, the suffix added to both programs
also needs to be the same. These are the limitations of the MD5
collision generation program that we use. Although there are other more
complicated and more advanced tools that can lift some of the
limitations, such as accepting two different
prefixes, they demand much more
computing power, so they are out of the scope for this lab. We need to
find a way to generate two different programs within the limitations.</p>
<p>There are many ways to achieve the above goal. We provide one approach
as a reference, but students are encouraged to come up their own ideas.
Instructors may consider rewarding students for their own ideas. In our
approach, we create two arrays <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">Y</span></code>. We compare the contents
of these two arrays; if they are the same, the benign code is executed;
otherwise, the malicious code is executed. See the following
pseudo-code:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Array X;
Array Y;

main()
{
  if(X&#39;s contents and Y&#39;s contents are the same)
      run benign code;
  else
      run malicious code;
  return;
}
</pre></div>
</div>
<p>We can initialize the arrays <code class="docutils literal notranslate"><span class="pre">X</span></code> and <code class="docutils literal notranslate"><span class="pre">Y</span></code> with some values that can
help us find their locations in the executable binary file. Our job is
to change the contents of these two arrays, so we can generate two
different versions that have the same MD5 hash. In one version, the
contents of X and Y are the same, so the benign code is executed; in the
other version, the contents of X and Y are different, so the malicious
code is executed. We can achieve this goal using a technique similar to
the one used in Task 3. <strong>Figure&nbsp;4</strong> illustrates
what the two versions of the program look like.</p>
<div class="align-center figure" id="id5">
<img alt="alternate text" src="../../_images/two_versions.jpg" />
<p class="caption"><span class="caption-text">Figure 4: An approach to generate two hash-colliding programs with different behaviors.</span></p>
</div>
<p>From <strong>Figure&nbsp;4</strong>, we know that these two binary
files have the same MD5 hash value, as long as <code class="docutils literal notranslate"><span class="pre">P</span></code> and <code class="docutils literal notranslate"><span class="pre">Q</span></code> are
generated accordingly. In the first version, we make the contents of
arrays X and Y the same, while in the second version, we make their
contents different. Therefore, the only thing we need to change is the
contents of these two arrays, and there is no need to change the logic
of the programs.</p>
</div>
</div>
<div class="section" id="submission">
<h2>Submission<a class="headerlink" href="#submission" title="Permalink to this headline">¶</a></h2>
<p>You need to submit a detailed lab report, with screenshots, to describe
what you have done and what you have observed. You also need to provide
explanation to the observations that are interesting or surprising.
Please also list the important code snippets followed by explanation.
Simply attaching code without any explanation will not receive credits.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="padding_oracle.html" class="btn btn-neutral float-right" title="Padding Oracle Attack Lab" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="hash_length_ext.html" class="btn btn-neutral float-left" title="Hash Length Extension Attack Lab" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, NEXUS Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>